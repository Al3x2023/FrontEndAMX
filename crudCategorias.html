<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Categorías</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <main class="container">
        <section class="form-section">
            <h2>Agregar/Actualizar Categoría</h2>
            <form id="categoriaForm" class="form">
                <input type="hidden" id="categoriaId">
                <input type="text" id="categoria" placeholder="Nombre de la categoría" required aria-label="Nombre de la categoría">
                <textarea id="descripcion" placeholder="Descripción" aria-label="Descripción"></textarea>
                <button type="submit">Agregar</button>
            </form>
        </section>

        <section class="list-section">
            <h2>Lista de Categorías</h2>
            <ul id="listaCategorias" class="category-list"></ul>
        </section>
    </main>

    <script src="layout.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadCategorias();
            document.getElementById("categoriaForm").addEventListener("submit", (event) => {
                event.preventDefault();
                if (document.getElementById("categoriaId").value) {
                    updateCategoria();
                } else {
                    agregarCategoria();
                }
            });
        });

        // Función para cargar las categorías desde el backend
        async function loadCategorias() {
            try {
                const response = await fetch("http://192.168.1.76:8000/categorias/", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${localStorage.getItem("access_token")}`
                    }
                });

                if (!response.ok) throw new Error("Error al cargar las categorías");

                const categorias = await response.json();
                displayCategorias(categorias);
            } catch (error) {
                alert("Error al cargar las categorías: " + error);
            }
        }

        // Función para mostrar las categorías en la lista
        function displayCategorias(categorias) {
            const lista = document.getElementById("listaCategorias");
            lista.innerHTML = "";

            categorias.forEach(categoria => {
                const li = document.createElement("li");
                li.innerHTML = `
                    <strong>${categoria.categoria}</strong>
                    <p>${categoria.descripcion || "Sin descripción"}</p>
                    <button onclick="editCategoria(${categoria.idCategoria})">Editar</button>
                    <button onclick="eliminarCategoria(${categoria.idCategoria})">Eliminar</button>
                `;
                lista.appendChild(li);
            });
        }

        // Función para agregar una nueva categoría
        async function agregarCategoria() {
            const categoria = document.getElementById("categoria").value;
            const descripcion = document.getElementById("descripcion").value;

            try {
                const response = await fetch("http://192.168.1.76:8000/categorias/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("access_token")}`
                    },
                    body: JSON.stringify({ categoria, descripcion })
                });

                if (!response.ok) throw new Error("Error al agregar la categoría");

                loadCategorias();
                document.getElementById("categoriaForm").reset();
            } catch (error) {
                alert("Error al agregar la categoría: " + error);
            }
        }

        // Función para editar una categoría
        async function editCategoria(idCategoria) {
            try {
                const response = await fetch(`http://192.168.1.76:8000/categorias/${idCategoria}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${localStorage.getItem("access_token")}`
                    }
                });

                if (!response.ok) throw new Error("Error al obtener la categoría");

                const categoria = await response.json();
                document.getElementById("categoriaId").value = categoria.idCategoria;
                document.getElementById("categoria").value = categoria.categoria;
                document.getElementById("descripcion").value = categoria.descripcion;
            } catch (error) {
                alert("Error al editar la categoría: " + error);
            }
        }

        // Función para actualizar una categoría
        async function updateCategoria() {
            const idCategoria = document.getElementById("categoriaId").value;
            const categoria = document.getElementById("categoria").value;
            const descripcion = document.getElementById("descripcion").value;

            try {
                const response = await fetch(`http://192.168.1.76:8000/categorias/${idCategoria}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("access_token")}`
                    },
                    body: JSON.stringify({ categoria, descripcion })
                });

                if (!response.ok) throw new Error("Error al actualizar la categoría");

                loadCategorias();
                document.getElementById("categoriaForm").reset();
            } catch (error) {
                alert("Error al actualizar la categoría: " + error);
            }
        }

        // Función para eliminar una categoría
        async function eliminarCategoria(idCategoria) {
            if (!confirm("¿Estás seguro de eliminar esta categoría?")) return;

            try {
                const response = await fetch(`http://192.168.1.76:8000/categorias/${idCategoria}`, {
                    method: "DELETE",
                    headers: {
                        "Authorization": `Bearer ${localStorage.getItem("access_token")}`
                    }
                });

                if (!response.ok) throw new Error("Error al eliminar la categoría");

                loadCategorias();
            } catch (error) {
                alert("Error al eliminar la categoría: " + error);
            }
        }
    </script>

</body>
</html>
