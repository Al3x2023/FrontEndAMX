<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css">
  <title>Gestión de Productos</title>

</head>
<body>
  <div class="container">
   

    <!-- Sección de filtros para mejorar la experiencia de búsqueda -->
    <section class="filter-section">
      <h2>Filtrar Productos</h2>
      <input type="text" id="buscarProducto" placeholder="Buscar por código o nombre">
      <select id="filtrarCategoria">
        <option value="">Todas las Categorías</option>
      </select>
      <button id="btnFiltrar">Filtrar</button>
    </section>

    <section>
      <h2>Lista de Productos</h2>
      <ul id="listaProductos"></ul>
    </section>
  </div>
  <section>
    <h2>Agregar Producto</h2>
    <form id="productoForm">
      <select id="idCategoria" required>
        <option value="">Seleccionar Categoría...</option>
      </select>
      <input type="text" id="nombreDelProducto" placeholder="Nombre del producto" required>
      <input type="text" id="codigoBarras" placeholder="Código de barras">
      <input type="text" id="codigoQR" placeholder="Código QR">
      <select id="presentacion">
        <option value="">Seleccionar Presentación...</option>
        <option value="Caja">Caja</option>
        <option value="Bulto">Bulto</option>
        <option value="Botella">Botella</option>
      </select>
      <select id="unidadDeMedida">
        <option value="">Seleccionar Unidad...</option>
        <option value="kg">Kilogramo</option>
        <option value="l">Litros</option>
        <option value="m">Metros</option>
      </select>
      <button type="submit">Agregar</button>
    </form>
  </section>
  <script src="layout.js"></script>
  <script>
    const API_URL = "http://192.168.1.76:8000";
    let productosGlobal = [];
    let categoriasGlobal = [];

    document.addEventListener("DOMContentLoaded", () => {
      loadProductos();
      loadCategorias();
      // Agregar listener al botón de filtrar
      document.getElementById("btnFiltrar").addEventListener("click", renderProductos);
      // También filtrar mientras se escribe
      document.getElementById("buscarProducto").addEventListener("input", renderProductos);
      document.getElementById("filtrarCategoria").addEventListener("change", renderProductos);
    });

    // Cargar categorías y poblar tanto el formulario de agregar como el filtro
    async function loadCategorias() {
      try {
        const response = await fetch(`${API_URL}/categorias/`);
        if (!response.ok) throw new Error("No se pudieron cargar las categorías.");
        const categorias = await response.json();
        categoriasGlobal = categorias; // Guardamos globalmente para usar en el filtro
        const selectForm = document.getElementById("idCategoria");
        const selectFiltro = document.getElementById("filtrarCategoria");
        selectForm.innerHTML = '<option value="">Seleccionar Categoría...</option>';
        selectFiltro.innerHTML = '<option value="">Todas las Categorías</option>';
        categorias.forEach(cat => {
          const optionForm = document.createElement("option");
          optionForm.value = cat.idCategoria;
          optionForm.textContent = `${cat.categoria} - ${cat.descripcion}`;
          selectForm.appendChild(optionForm);
          
          const optionFiltro = document.createElement("option");
          optionFiltro.value = cat.idCategoria;
          optionFiltro.textContent = cat.categoria;
          selectFiltro.appendChild(optionFiltro);
        });
      } catch (error) {
        alert("Error al cargar categorías: " + error);
      }
    }

    // Cargar productos y almacenarlos en una variable global
    async function loadProductos() {
      try {
        const response = await fetch(`${API_URL}/productos/`);
        if (!response.ok) throw new Error("No se pudieron cargar los productos.");
        const productos = await response.json();
        productosGlobal = productos;
        renderProductos();
      } catch (error) {
        alert("Error al cargar productos: " + error);
      }
    }

    // Función para renderizar productos filtrados
    function renderProductos() {
      const filtroTexto = document.getElementById("buscarProducto").value.trim().toLowerCase();
      const filtroCategoria = document.getElementById("filtrarCategoria").value;
      const lista = document.getElementById("listaProductos");
      lista.innerHTML = "";
      
      const productosFiltrados = productosGlobal.filter(prod => {
        let coincideCategoria = true;
        let coincideBusqueda = true;
        if (filtroCategoria) {
          coincideCategoria = String(prod.idCategoria) === filtroCategoria;
        }
        if (filtroTexto) {
          const texto = `${prod.nombreDelProducto} ${prod.codigoBarras || ""}`.toLowerCase();
          coincideBusqueda = texto.includes(filtroTexto);
        }
        return coincideCategoria && coincideBusqueda;
      });

      if (productosFiltrados.length === 0) {
        lista.innerHTML = "<li>No se encontraron productos</li>";
        return;
      }

      productosFiltrados.forEach(producto => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${producto.nombreDelProducto}</strong>
          <p>Código de barras: ${producto.codigoBarras || "N/A"}</p>
          <p>Categoría: ${producto.idCategoria}</p>
          <button onclick="eliminarProducto(${producto.idProducto})">Eliminar</button>
        `;
        lista.appendChild(li);
      });
    }

    // Función para agregar un nuevo producto
    async function agregarProducto() {
      const idCategoria = parseInt(document.getElementById("idCategoria").value, 10);
      const nombreDelProducto = document.getElementById("nombreDelProducto").value.trim();
      const codigoBarras = document.getElementById("codigoBarras").value.trim() || null;
      const codigoQR = document.getElementById("codigoQR").value.trim() || null;
      const presentacion = document.getElementById("presentacion").value || null;
      const unidadDeMedida = document.getElementById("unidadDeMedida").value || null;
      
      if (!idCategoria || !nombreDelProducto) {
        alert("Debe seleccionar una categoría y llenar el nombre del producto.");
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}/productos/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ idCategoria, nombreDelProducto, codigoBarras, codigoQR, presentacion, unidadDeMedida })
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || "Error al agregar producto.");
        }
        await loadProductos();
        document.getElementById("productoForm").reset();
      } catch (error) {
        alert("Error: " + error);
      }
    }

    // Función para eliminar un producto
    async function eliminarProducto(idProducto) {
      try {
        const response = await fetch(`${API_URL}/productos/${idProducto}`, {
          method: "DELETE"
        });
        if (!response.ok) throw new Error("Error al eliminar producto.");
        await loadProductos();
      } catch (error) {
        alert("Error: " + error);
      }
    }

    document.getElementById("productoForm").addEventListener("submit", async function(event) {
      event.preventDefault();
      await agregarProducto();
    });
  </script>
</body>
</html>
