<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Usuarios</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
  

    <main>
        <section>
            
            <button onclick="mostrarFormularioCrearUsuario()">Crear Usuario</button>
           
            <div id="formulario-usuario" style="display: none;">
                <h2>Crear Nuevo Usuario</h2>
                <label for="nombreUsuario">Nombre</label>
                <input type="text" id="nombreUsuario">
                <label for="correoUsuario">Correo Electrónico</label>
                <input type="email" id="correoUsuario">
                <label for="rolUsuario">Rol</label>
                <input type="text" id="rolUsuario">
                <label for="contrasenaUsuario">Contraseña</label>
                <input type="password" id="contrasenaUsuario">
                <button onclick="crearUsuario()">Crear</button>
            </div>
        </section>

        <section>
            <h2>Lista de Usuarios</h2>
            <table id="tablaUsuarios">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Rol</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>

    <div id="formulario-editar" style="display: none;">
        <h2>Editar Usuario</h2>
        <label for="editarNombre">Nombre</label>
        <input type="text" id="editarNombre">
        <label for="editarCorreo">Correo Electrónico</label>
        <input type="email" id="editarCorreo">
        <label for="editarRol">Rol</label>
        <input type="text" id="editarRol">
        <button onclick="guardarEdicionUsuario()">Guardar</button>
        <button onclick="cerrarFormularioEditar()">Cancelar</button>
    </div>
<script src="layout.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            loadUsuarios();
        });

       

        function mostrarFormularioCrearUsuario() {
            document.getElementById("formulario-usuario").style.display = "block";
        }

        function crearUsuario() {
            const nombre = document.getElementById("nombreUsuario").value;
            const correo = document.getElementById("correoUsuario").value;
            const rol = document.getElementById("rolUsuario").value;
            const contrasena = document.getElementById("contrasenaUsuario").value;

            const usuarioData = { nombre, correoElectronico: correo, rol, contrasena };

            fetch('http://192.168.1.76:8000/usuarios/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem("access_token")}`
                },
                body: JSON.stringify(usuarioData)
            })
            .then(response => response.json())
            .then(() => {
                alert("Usuario creado con éxito");
                loadUsuarios();
                document.getElementById("formulario-usuario").style.display = "none";
            })
            .catch(error => alert("Error al crear usuario: " + error));
        }

        function loadUsuarios() {
    const idSucursal = localStorage.getItem("idSucursal");

    if (!idSucursal) {
        alert("Error: No se encontró el idSucursal en la sesión.");
        return;
    }

    fetch('http://192.168.1.76:8000/usuarios/', {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${localStorage.getItem("access_token")}` }
    })
    .then(response => response.json())
    .then(usuarios => {
        const tabla = document.getElementById("tablaUsuarios").getElementsByTagName('tbody')[0];
        tabla.innerHTML = '';

        // Filtrar usuarios por idSucursal
        const usuariosFiltrados = usuarios.filter(usuario => usuario.idSucursal == idSucursal);

        usuariosFiltrados.forEach(usuario => {
            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td>${usuario.idUsuario}</td>
                <td>${usuario.nombre}</td>
                <td>${usuario.correoElectronico}</td>
                <td>${usuario.rol}</td>
                <td>
                    <button onclick="editarUsuario(${usuario.idUsuario}, '${usuario.nombre}', '${usuario.correoElectronico}', '${usuario.rol}')">Editar</button>
                    <button onclick="eliminarUsuario(${usuario.idUsuario})">Eliminar</button>
                </td>
            `;
            tabla.appendChild(fila);
        });

        if (usuariosFiltrados.length === 0) {
            console.warn("No hay usuarios en esta sucursal.");
        }
    })
    .catch(error => alert("Error al cargar los usuarios: " + error));
}

        function editarUsuario(id, nombre, correo, rol) {
            document.getElementById("editarNombre").value = nombre;
            document.getElementById("editarCorreo").value = correo;
            document.getElementById("editarRol").value = rol;
            document.getElementById("formulario-editar").style.display = "block";
            document.getElementById("formulario-editar").dataset.id = id;
        }

        function guardarEdicionUsuario() {
            const id = document.getElementById("formulario-editar").dataset.id;
            const nombre = document.getElementById("editarNombre").value;
            const correo = document.getElementById("editarCorreo").value;
            const rol = document.getElementById("editarRol").value;

            const usuarioData = { nombre, correoElectronico: correo, rol };

            fetch(`http://192.168.1.76:8000/usuarios/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem("access_token")}`
                },
                body: JSON.stringify(usuarioData)
            })
            .then(response => response.json())
            .then(() => {
                alert("Usuario actualizado con éxito");
                loadUsuarios();
                cerrarFormularioEditar();
            })
            .catch(error => alert("Error al actualizar usuario: " + error));
        }

        function cerrarFormularioEditar() {
            document.getElementById("formulario-editar").style.display = "none";
        }

        function eliminarUsuario(id) {
            fetch(`http://192.168.1.76:8000/usuarios/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${localStorage.getItem("access_token")}` }
            })
            .then(() => {
                alert("Usuario eliminado");
                loadUsuarios();
            })
            .catch(error => alert("Error al eliminar usuario: " + error));
        }
    </script>
</body>
</html>
