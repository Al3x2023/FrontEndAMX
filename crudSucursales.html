<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Sucursales</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
 



  <main>
    <section>
      <button onclick="mostrarFormularioCrearSucursal()">Crear Sucursal</button>
      <div id="formulario-sucursal" style="display: none;">
        <h2 id="tituloFormulario">Crear Nueva Sucursal</h2>
        <label for="nombreSucursal">Nombre</label>
        <input type="text" id="nombreSucursal" />
        <label for="direccionSucursal">Dirección</label>
        <input type="text" id="direccionSucursal" />
        <label for="telefonoMovil">Teléfono Móvil</label>
        <input type="text" id="telefonoMovil" />
        <label for="telefonoFijo">Teléfono Fijo</label>
        <input type="text" id="telefonoFijo" />
        <label for="correoElectronico">Correo Electrónico</label>
        <input type="email" id="correoElectronico" />
        <label for="codigoPostal">Código Postal</label>
        <input type="text" id="codigoPostal" />
        <button onclick="guardarSucursal()">Guardar</button>
      </div>
    </section>

    <section>
      <h2>Lista de Sucursales</h2>
      <ul id="listaSucursales">
        <!-- Se cargarán las sucursales -->
      </ul>
    </section>
  </main>

  <script src="layout.js"></script>
  <script>
    // Variable global que indica si se está editando una sucursal (objeto) o se creará una nueva (null)
    let sucursalEditando = null;

    document.addEventListener("DOMContentLoaded", () => {
      loadSucursales();
    });


    // Muestra el formulario en modo creación (campos vacíos y modo creación)
    function mostrarFormularioCrearSucursal() {
      const formulario = document.getElementById("formulario-sucursal");
      formulario.style.display = "block";
      document.getElementById("tituloFormulario").innerText = "Crear Nueva Sucursal";
      // Limpiar campos
      document.getElementById("nombreSucursal").value = "";
      document.getElementById("direccionSucursal").value = "";
      document.getElementById("telefonoMovil").value = "";
      document.getElementById("telefonoFijo").value = "";
      document.getElementById("correoElectronico").value = "";
      document.getElementById("codigoPostal").value = "";
      sucursalEditando = null; // Se indica que es modo creación
    }

    // Muestra el formulario en modo edición con los datos de la sucursal recibida
    function mostrarFormularioEditarSucursal(sucursal) {
      const formulario = document.getElementById("formulario-sucursal");
      formulario.style.display = "block";
      document.getElementById("tituloFormulario").innerText = "Editar Sucursal";
      document.getElementById("nombreSucursal").value = sucursal.nombreDeLaSucursal;
      document.getElementById("direccionSucursal").value = sucursal.direccion;
      document.getElementById("telefonoMovil").value = sucursal.telefonoMovil || "";
      document.getElementById("telefonoFijo").value = sucursal.telefonoFijo || "";
      document.getElementById("correoElectronico").value = sucursal.correoElectronico;
      document.getElementById("codigoPostal").value = sucursal.codigoPostal || "";
    }

    // Función que se invoca al presionar "Editar" en alguna sucursal; carga la sucursal y muestra el formulario de edición
    function editarSucursal(id) {
      fetch(`http://192.168.1.76:8000/sucursales/${id}`, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${localStorage.getItem("access_token")}`
        }
      })
        .then(response => response.json())
        .then(sucursal => {
          sucursalEditando = sucursal; // Se guarda la sucursal a editar
          mostrarFormularioEditarSucursal(sucursal);
        })
        .catch(error =>
          alert("Error al cargar los datos de la sucursal: " + error)
        );
    }

    // Función que guarda la sucursal (crea o actualiza según el modo)
    function guardarSucursal() {
      const nombre = document.getElementById("nombreSucursal").value;
      const direccion = document.getElementById("direccionSucursal").value;
      const telefonoMovil = document.getElementById("telefonoMovil").value;
      const telefonoFijo = document.getElementById("telefonoFijo").value;
      const correoElectronico = document.getElementById("correoElectronico").value;
      const codigoPostal = document.getElementById("codigoPostal").value;
      const idSucursalPadre = localStorage.getItem("idSucursal");

      const sucursalData = {
        nombreDeLaSucursal: nombre,
        direccion: direccion,
        telefonoMovil: telefonoMovil || null,
        telefonoFijo: telefonoFijo || null,
        correoElectronico: correoElectronico,
        codigoPostal: codigoPostal || null,
        idSucursalPadre: idSucursalPadre
      };

      if (sucursalEditando) {
        // Modo edición: actualizar la sucursal existente
        fetch(`http://192.168.1.76:8000/sucursales/${sucursalEditando.idSucursal}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("access_token")}`
          },
          body: JSON.stringify(sucursalData)
        })
          .then(response => response.json())
          .then(data => {
            alert("Sucursal actualizada con éxito");
            loadSucursales();
            document.getElementById("formulario-sucursal").style.display = "none";
            sucursalEditando = null;
          })
          .catch(error =>
            alert("Error al actualizar sucursal: " + error)
          );
      } else {
        // Modo creación: crear una nueva sucursal
        fetch("http://192.168.1.76:8000/sucursales/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("access_token")}`
          },
          body: JSON.stringify(sucursalData)
        })
          .then(response => response.json())
          .then(data => {
            alert("Sucursal creada con éxito");
            loadSucursales();
            document.getElementById("formulario-sucursal").style.display = "none";
          })
          .catch(error =>
            alert("Error al crear sucursal: " + error)
          );
      }
    }

    // Cargar todas las sucursales y mostrarlas en la lista
    function loadSucursales() {
      const idSucursalPadre = localStorage.getItem("idSucursal");

      fetch("http://192.168.1.76:8000/sucursales/", {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${localStorage.getItem("access_token")}`
        }
      })
        .then(response => response.json())
        .then(sucursales => {
          const lista = document.getElementById("listaSucursales");
          lista.innerHTML = ""; // Limpiar lista

          // Filtrar sucursales que pertenezcan al superadmin (según idSucursalPadre)
          const sucursalesFiltradas = sucursales.filter(
            sucursal => sucursal.idSucursalPadre == idSucursalPadre
          );

          sucursalesFiltradas.forEach(sucursal => {
            const li = document.createElement("li");
            li.innerHTML = `
              <strong>${sucursal.nombreDeLaSucursal}</strong><br>
              Dirección: ${sucursal.direccion}<br>
              Teléfono Móvil: ${sucursal.telefonoMovil || "No especificado"}<br>
              Teléfono Fijo: ${sucursal.telefonoFijo || "No especificado"}<br>
              Correo Electrónico: ${sucursal.correoElectronico}<br>
              Código Postal: ${sucursal.codigoPostal || "No especificado"}<br>
              ${sucursal.idSucursalPadre ? `<small>Sucursal Padre: ${sucursal.idSucursalPadre}</small>` : ""}
              <button onclick="editarSucursal(${sucursal.idSucursal})">Editar</button>
              <button onclick="eliminarSucursal(${sucursal.idSucursal})">Eliminar</button>
            `;
            lista.appendChild(li);
          });
        })
        .catch(error =>
          alert("Error al cargar las sucursales: " + error)
        );
    }

    // Eliminar una sucursal
    function eliminarSucursal(id) {
      fetch(`http://192.168.1.76:8000/sucursales/${id}`, {
        method: "DELETE",
        headers: {
          "Authorization": `Bearer ${localStorage.getItem("access_token")}`
        }
      })
        .then(response => response.json())
        .then(data => {
          alert("Sucursal eliminada");
          loadSucursales();
        })
        .catch(error =>
          alert("Error al eliminar sucursal: " + error)
        );
    }
  </script>
</body>
</html>
