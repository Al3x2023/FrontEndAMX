<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css">
  <title>Gestión de Entradas y Salidas</title>
  <style>
    body { font-family: Arial, sans-serif; }
    .container { width: 80%; margin: auto; }
    nav { margin-bottom: 20px; }
    nav button { margin-right: 10px; }
    form { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    ul { list-style-type: none; padding: 0; }
    li { border: 1px solid #ccc; margin-bottom: 10px; padding: 10px; }
    .acciones button { margin-right: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <nav>
      <button onclick="mostrarSeccion('entradas')">Entradas</button>
      <button onclick="mostrarSeccion('salidas')">Salidas</button>
    </nav>
  
    <main>
      <!-- Sección Entradas -->
      <section id="entradas-section">
        <h2>Entradas</h2>
        <form id="form-entrada">
          <h3>Nueva Entrada</h3>
          <!-- Utilizamos un datalist para autocompletar productos -->
          <label for="entrada-producto">Producto (Código de Barras o Nombre):</label>
          <input type="text" id="entrada-producto" name="producto" list="lista-productos" required />
          <datalist id="lista-productos"></datalist>
  
          <!-- Selección de Proveedor mediante datalist -->
          <label for="entrada-proveedor">Proveedor:</label>
          <input type="text" id="entrada-proveedor" name="proveedor" list="lista-proveedores" required />
          <datalist id="lista-proveedores"></datalist>
  
          <!-- Campo autocompletado con idSucursal del usuario -->
          <label for="entrada-idSucursal">ID Sucursal:</label>
          <input type="number" id="entrada-idSucursal" name="idSucursal" readonly required />
  
          <label for="entrada-cantidad">Cantidad:</label>
          <input type="number" id="entrada-cantidad" name="cantidad" min="1" required />
  
          <label for="entrada-precioDeCompra">Precio de Compra:</label>
          <input type="number" step="0.01" id="entrada-precioDeCompra" name="precioDeCompra" required />
  
          <button type="submit">Crear Entrada</button>
        </form>
  
        <h3>Lista de Entradas</h3>
        <ul id="entradas-list"></ul>
      </section>
  
     <!-- Sección Salidas -->
<section id="salidas-section" style="display: none;">
  <h2>Salidas</h2>
  <form id="form-salida">
    <h3>Nueva Salida</h3>
    <label for="salida-codigoBarras">Código de Barras:</label>
    <input type="text" id="salida-codigoBarras" name="codigoBarras" placeholder="Ingrese el código de barras" />
    <button type="button" onclick="buscarProductoPorCodigo()">Buscar Producto</button>
    <div id="infoProducto" style="margin: 10px 0; font-weight: bold;"></div>

    <!-- Utilizamos un datalist para autocompletar productos en salidas -->
    <label for="salida-producto">Producto:</label>
    <input type="text" id="salida-producto" name="producto" list="lista-productos-salida" required />
    <datalist id="lista-productos-salida"></datalist>

    <label for="salida-idSucursal">ID Sucursal:</label>
    <input type="number" id="salida-idSucursal" name="idSucursal" readonly required />

    <label for="salida-cantidad">Cantidad:</label>
    <input type="number" id="salida-cantidad" name="cantidad" min="1" required />

    <label for="salida-precioDeVenta">Precio de Venta:</label>
    <input type="number" step="0.01" id="salida-precioDeVenta" name="precioDeVenta" required />

    <label for="salida-pagoRecibido">Pago Recibido:</label>
    <input type="number" step="0.01" id="salida-pagoRecibido" name="pagoRecibido" required />

    <label for="salida-metodoDePago">Método de Pago:</label>
    <select id="salida-metodoDePago" name="metodoDePago" required>
      <option value="efectivo">Efectivo</option>
      <option value="tarjeta">Tarjeta</option>
      <option value="transferencia">Transferencia</option>
      <option value="otros">Otros</option>
    </select>

    <button type="submit">Crear Salida</button>
  </form>

  <h3>Lista de Salidas</h3>
  <ul id="salidas-list"></ul>
</section>  
<!-- Sección del Ticket -->
<section id="ticket-section" style="display: none;">
  <h2>Ticket</h2>
  <div id="ticket-content">
    <!-- Aquí se actualizarán los detalles del ticket -->
  </div>
  <button onclick="ocultarTicket()">Cerrar Ticket</button>
</section>

    </main>
  </div>
  
  <script>
    
    // URL base de la API (ajustar según tu entorno)
    const API_URL = "http://192.168.1.76:8000";
  
    // Se obtiene el idSucursal del usuario desde localStorage
    function setSucursalEnFormularios() {
      const idSucursal = localStorage.getItem("idSucursal") || 1;
      document.getElementById("entrada-idSucursal").value = idSucursal;
      document.getElementById("salida-idSucursal").value = idSucursal;
    }
  
    function mostrarSeccion(seccion) {
    document.getElementById("entradas-section").style.display = seccion === "entradas" ? "block" : "none";
    document.getElementById("salidas-section").style.display = seccion === "salidas" ? "block" : "none";
    document.getElementById("ticket-section").style.display = "none"; // Oculta el ticket si está abierto

    // Esperar a que el navegador actualice el DOM antes de aplicar focus()
    requestAnimationFrame(() => {
      setTimeout(() => enfocarCodigoBarras(seccion), 50);
    });
  }

  function enfocarCodigoBarras(seccion) {
    let campo = null;
    if (seccion === "entradas") {
      campo = document.getElementById("entrada-producto");
    } else if (seccion === "salidas") {
      campo = document.getElementById("salida-codigoBarras");
    }

    if (campo) {
      campo.focus();
      console.log(`Foco en: ${campo.id}`);
    } else {
      console.log("No se encontró el campo de entrada.");
    }
  }

  // Asegurar que al cargar la página el campo correcto esté enfocado
  document.addEventListener("DOMContentLoaded", () => {
    const seccionInicial = document.getElementById("entradas-section").style.display !== "none" ? "entradas" : "salidas";
    requestAnimationFrame(() => {
      setTimeout(() => enfocarCodigoBarras(seccionInicial), 50);
    });
  });
    // Función auxiliar para peticiones con autenticación
    function fetchWithAuth(url, options = {}) {
      const token = localStorage.getItem("access_token");
      const headers = {
        ...options.headers,
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      };
      return fetch(url, { ...options, headers });
    }
  
    // Función para poblar los datalists de productos y proveedores
    async function poblarListas() {
      try {
        // Obtener productos
        const resProductos = await fetchWithAuth(`${API_URL}/productos/`);
        const productos = await resProductos.json();
        const listaProductosEntrada = document.getElementById("lista-productos");
        const listaProductosSalida = document.getElementById("lista-productos-salida");
        listaProductosEntrada.innerHTML = "";
        listaProductosSalida.innerHTML = "";
        productos.forEach(producto => {
          const option = document.createElement("option");
          option.value = `${producto.codigoBarras} - ${producto.nombreDelProducto} (ID: ${producto.idProducto})`;
          listaProductosEntrada.appendChild(option);
          const optionSalida = option.cloneNode(true);
          listaProductosSalida.appendChild(optionSalida);
        });
  
        // Obtener proveedores
        const resProveedores = await fetchWithAuth(`${API_URL}/proveedores/`);
        const proveedores = await resProveedores.json();
        const listaProveedores = document.getElementById("lista-proveedores");
        listaProveedores.innerHTML = "";
        proveedores.forEach(proveedor => {
          const option = document.createElement("option");
          option.value = `${proveedor.nombre} (ID: ${proveedor.idProveedor})`;
          listaProveedores.appendChild(option);
        });
      } catch (error) {
        console.error("Error al poblar listas:", error);
      }
    }
  
    // BUSCAR PRODUCTO POR CÓDIGO DE BARRAS (para la sección Salidas)
    async function buscarProductoPorCodigo() {
      const codigo = document.getElementById("salida-codigoBarras").value.trim();
      if (!codigo) {
        alert("Ingrese un código de barras");
        return;
      }
      try {
        const res = await fetchWithAuth(`${API_URL}/productos/`);
        const productos = await res.json();
        const producto = productos.find(p => String(p.codigoBarras) === codigo);
        if (producto) {
          document.getElementById("infoProducto").textContent = `Producto encontrado: ${producto.nombreDelProducto} (ID: ${producto.idProducto})`;
          document.getElementById("salida-producto").value = `${producto.codigoBarras} - ${producto.nombreDelProducto} (ID: ${producto.idProducto})`;
        } else {
          document.getElementById("infoProducto").textContent = "No se encontró ningún producto con ese código.";
          document.getElementById("salida-producto").value = "";
        }
      } catch (error) {
        alert("Error al buscar el producto: " + error);
      }
    }
  
    // Función para cargar las entradas registradas
    async function loadEntradas() {
      try {
        const res = await fetchWithAuth(`${API_URL}/entradas/`);
        const entradas = await res.json();
        const lista = document.getElementById("entradas-list");
        lista.innerHTML = "";
        entradas.forEach(entrada => {
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>ID Entrada:</strong> ${entrada.idEntrada} <br>
            <strong>ID Producto:</strong> ${entrada.idProducto} <br>
            <strong>ID Sucursal:</strong> ${entrada.idSucursal} <br>
            <strong>ID Proveedor:</strong> ${entrada.idProveedor} <br>
            <strong>Cantidad:</strong> ${entrada.cantidad} <br>
            <strong>Precio de Compra:</strong> $${entrada.precioDeCompra} <br>
            <div class="acciones">
              <button onclick="editarEntrada(${entrada.idEntrada})">Editar</button>
              <button onclick="eliminarEntrada(${entrada.idEntrada})">Eliminar</button>
            </div>
          `;
          lista.appendChild(li);
        });
      } catch (error) {
        alert("Error al cargar las entradas: " + error);
      }
    }
  
    async function loadSalidas() {
      try {
        const res = await fetchWithAuth(`${API_URL}/salidas/`);
        const salidas = await res.json();
        const lista = document.getElementById("salidas-list");
        lista.innerHTML = "";
        salidas.forEach(salida => {
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>ID Salida:</strong> ${salida.idSalida} <br>
            <strong>ID Producto:</strong> ${salida.idProducto} <br>
            <strong>ID Sucursal:</strong> ${salida.idSucursal} <br>
            <strong>Cantidad:</strong> ${salida.cantidad} <br>
            <strong>Precio de Venta:</strong> $${salida.precioDeVenta} <br>
            <strong>Pago Recibido:</strong> $${salida.pagoRecibido} <br>
            <strong>Método de Pago:</strong> ${salida.metodoDePago} <br>
            <div class="acciones">
              <button onclick="editarSalida(${salida.idSalida})">Editar</button>
              <button onclick="eliminarSalida(${salida.idSalida})">Eliminar</button>
            </div>
          `;
          lista.appendChild(li);
        });
      } catch (error) {
        alert("Error al cargar las salidas: " + error);
      }
    }
  
    // Función para buscar o registrar un producto en la entrada
    async function buscarORegistrarProducto() {
      const inputProducto = document.getElementById("entrada-producto");
      const busqueda = inputProducto.value.trim();
      if (!busqueda) {
        alert("Ingrese un código de barras o nombre del producto");
        return;
      }
  
      try {
        const res = await fetchWithAuth(`${API_URL}/productos/`);
        const productos = await res.json();
        
        // Intentar extraer el ID si ya está formateado en el input
        const idMatch = busqueda.match(/ID:\s*(\d+)/);
        let producto;
        if (idMatch) {
          const idProducto = parseInt(idMatch[1]);
          producto = productos.find(p => p.idProducto === idProducto);
        }
        
        // Si no se encontró por ID, buscar por código o nombre
        if (!producto) {
          producto = productos.find(p => String(p.codigoBarras) === busqueda || 
                                          p.nombreDelProducto.toLowerCase() === busqueda.toLowerCase());
        }
        
        if (!producto) {
          const nombre = prompt("Producto no encontrado. Ingrese el nombre del producto:");
          if (!nombre) return;
          const nuevoProducto = {
            idCategoria: 1,
            nombreDelProducto: nombre,
            codigoBarras: busqueda,
            codigoQR: "",
            presentacion: "",
            unidadDeMedida: ""
          };
          const createRes = await fetchWithAuth(`${API_URL}/productos/`, {
            method: "POST",
            body: JSON.stringify(nuevoProducto)
          });
          producto = await createRes.json();
          alert("Producto registrado exitosamente");
        }
  
        // Actualiza el input con el valor formateado (incluyendo el ID)
        inputProducto.value = `${producto.codigoBarras} - ${producto.nombreDelProducto} (ID: ${producto.idProducto})`;
      } catch (error) {
        alert("Error al buscar o registrar el producto: " + error);
      }
    }
  
    // Crear nueva entrada
    document.getElementById("form-entrada").addEventListener("submit", async (e) => {
      e.preventDefault();
      await buscarORegistrarProducto();
  
      // Extraer el ID del producto del input (suponiendo que ya viene formateado)
      const productoStr = document.getElementById("entrada-producto").value;
      const idProducto = productoStr.match(/ID:\s*(\d+)/) ? parseInt(productoStr.match(/ID:\s*(\d+)/)[1]) : null;
      if (!idProducto) {
        alert("No se pudo extraer el ID del producto");
        return;
      }
  
      // Extraer el ID del proveedor de manera similar
      const proveedorStr = document.getElementById("entrada-proveedor").value;
      const idProveedor = proveedorStr.match(/ID:\s*(\d+)/) ? parseInt(proveedorStr.match(/ID:\s*(\d+)/)[1]) : null;
      if (!idProveedor) {
        alert("No se pudo extraer el ID del proveedor");
        return;
      }
  
      const cantidad = parseInt(document.getElementById("entrada-cantidad").value);
  
      const formData = {
        idProducto,
        idSucursal: parseInt(document.getElementById("entrada-idSucursal").value),
        idProveedor,
        cantidad,
        precioDeCompra: parseFloat(document.getElementById("entrada-precioDeCompra").value)
      };
  
      try {
        const res = await fetchWithAuth(`${API_URL}/entradas/`, {
          method: "POST",
          body: JSON.stringify(formData)
        });
        if (!res.ok) throw new Error("No se pudo crear la entrada");
    
        // Actualizar inventario: para entradas, se suma la cantidad
        await actualizarStock(formData.idSucursal, formData.idProducto, cantidad, "entrada");
    
        document.getElementById("form-entrada").reset();
        setSucursalEnFormularios();
        loadEntradas();
      } catch (error) {
        alert("Error al crear la entrada: " + error);
      }
    });
  
   // Función para manejar la creación de la salida
document.getElementById("form-salida").addEventListener("submit", async (e) => {
  e.preventDefault();
  
  // Extraer el ID del producto del input en salida
  const productoStr = document.getElementById("salida-producto").value;
  const idProducto = productoStr.match(/ID:\s*(\d+)/) ? parseInt(productoStr.match(/ID:\s*(\d+)/)[1]) : null;
  if (!idProducto) {
    alert("No se pudo extraer el ID del producto en la salida");
    return;
  }

  const cantidad = parseInt(document.getElementById("salida-cantidad").value);
  const precioDeVenta = parseFloat(document.getElementById("salida-precioDeVenta").value);
  const pagoRecibido = parseFloat(document.getElementById("salida-pagoRecibido").value);
  
  // Cálculo del total de la venta (cantidad * precio)
  const totalVenta = cantidad * precioDeVenta;
  
  // Cálculo de la diferencia entre lo estimado y lo recibido
  const diferencia = pagoRecibido - totalVenta;
  
  // Mostrar información sobre la diferencia
  if (diferencia > 0) {
    alert(`El pago recibido es superior en ${diferencia.toFixed(2)}. Puede devolver el cambio.`);
  } else if (diferencia < 0) {
    alert(`Falta pagar ${Math.abs(diferencia).toFixed(2)}. Asegúrese de recibir el pago completo.`);
  } else {
    alert("El pago recibido es correcto.");
  }

  const formData = {
    idProducto,
    idSucursal: parseInt(document.getElementById("salida-idSucursal").value),
    cantidad,
    precioDeVenta,
    pagoRecibido,
    metodoDePago: document.getElementById("salida-metodoDePago").value
  };

  try {
    const res = await fetchWithAuth(`${API_URL}/salidas/`, {
      method: "POST",
      body: JSON.stringify(formData)
    });
    if (!res.ok) throw new Error("No se pudo crear la salida");

    // Actualizar inventario: para salidas, se resta la cantidad
    await actualizarStock(formData.idSucursal, formData.idProducto, formData.cantidad, "salida");

    document.getElementById("form-salida").reset();
    document.getElementById("infoProducto").textContent = "";
    loadSalidas();
    setSucursalEnFormularios();
  } catch (error) {
    alert("Error al crear la salida: " + error);
  }
});
    // Actualizar stock: diferencia entre entrada y salida según "tipo"
    async function actualizarStock(idSucursal, idProducto, cantidad, tipo) {
      try {
        const ajuste = tipo === "entrada" ? cantidad : -cantidad;
        const payload = {
          idSucursal,
          idProducto,
          cantidad: ajuste
        };
        const res = await fetchWithAuth(`${API_URL}/inventarios/actualizar_stock`, {
          method: "PUT",
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("Error al actualizar el stock");
      } catch (error) {
        alert("Error al actualizar el stock: " + error);
      }
    }
  
    // Funciones para eliminar registros
    async function eliminarEntrada(idEntrada) {
      if (!confirm("¿Estás seguro de eliminar esta entrada?")) return;
      try {
        const res = await fetchWithAuth(`${API_URL}/entradas/${idEntrada}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Error al eliminar la entrada");
        loadEntradas();
      } catch (error) {
        alert("Error al eliminar la entrada: " + error);
      }
    }
  
    async function eliminarSalida(idSalida) {
      if (!confirm("¿Estás seguro de eliminar esta salida?")) return;
      try {
        const res = await fetchWithAuth(`${API_URL}/salidas/${idSalida}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Error al eliminar la salida");
        loadSalidas();
      } catch (error) {
        alert("Error al eliminar la salida: " + error);
      }
    }
  
    // Funciones para editar registros (ejemplo básico usando prompt)
    async function editarEntrada(idEntrada) {
      const nuevosValores = prompt("Ingrese nuevos valores en formato JSON (ejemplo: {\"cantidad\":5, \"precioDeCompra\":12.50})");
      if (!nuevosValores) return;
      try {
        const updateData = JSON.parse(nuevosValores);
        const res = await fetchWithAuth(`${API_URL}/entradas/${idEntrada}`, {
          method: "PUT",
          body: JSON.stringify(updateData)
        });
        if (!res.ok) throw new Error("Error al actualizar la entrada");
        loadEntradas();
      } catch (error) {
        alert("Error al editar la entrada: " + error);
      }
    }
  
    async function editarSalida(idSalida) {
      const nuevosValores = prompt("Ingrese nuevos valores en formato JSON (ejemplo: {\"cantidad\":3, \"precioDeVenta\":15.00})");
      if (!nuevosValores) return;
      try {
        const updateData = JSON.parse(nuevosValores);
        const res = await fetchWithAuth(`${API_URL}/salidas/${idSalida}`, {
          method: "PUT",
          body: JSON.stringify(updateData)
        });
        if (!res.ok) throw new Error("Error al actualizar la salida");
        loadSalidas();
      } catch (error) {
        alert("Error al editar la salida: " + error);
      }
    }
  
    document.addEventListener("DOMContentLoaded", () => {
      setSucursalEnFormularios();
      loadEntradas();
      loadSalidas();
      poblarListas();
    });
  </script>
  <script src="layout.js"></script>
</body>
</html>
