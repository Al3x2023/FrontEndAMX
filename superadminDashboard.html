<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Superadmin</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  
  <main>
    <!-- Sección de métricas generales obtenidas desde el endpoint /dashboard/resumen/{idSucursal} -->
    <section class="dashboard">
      <div class="card">Ingresos Brutos: <span id="totalVentas">$0.00</span></div>
      <div class="card">Ingresos Totales: <span id="ingresosTotales">$0.00</span></div>
      <div class="card">Egresos Totales: <span id="egresosTotales">$0.00</span></div>
      <div class="card">Balance: <span id="balance">$0.00</span></div>
      <div class="card">Top Producto Vendido: <span id="topProducto">-</span></div>
    </section>

    <!-- Gráfico de Ventas por Producto -->
    <section>
      <h2>Ventas por Producto</h2>
      <canvas id="graficoProductos"></canvas>
    </section>

    <!-- Actividad Reciente (últimas entradas y salidas) -->
    <section class="movimientos-financieros">
      <h2>Actividad Reciente</h2>
      <ul id="actividad-reciente"></ul>
    </section>
  </main>
  
  <script src="layout.js"></script>

  <script>
    function toggleMenu() {
      const navUl = document.querySelector(".navbar ul");
      navUl.classList.toggle("active");
    }

    document.addEventListener("DOMContentLoaded", () => {
      initializeDashboard();
    });

    // Función para realizar peticiones con token de autenticación
    function fetchWithAuth(url, options = {}) {
      const token = localStorage.getItem("access_token");
      const headers = {
        ...options.headers,
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      };
      return fetch(url, { ...options, headers });
    }

    async function initializeDashboard() {
      try {
        const idSucursal = localStorage.getItem("idSucursal");
        if (!idSucursal) throw new Error("No se encontró el ID de la sucursal en el almacenamiento local.");
        await Promise.all([
          loadResumenDashboard(idSucursal),
          loadProductosMasVendidos(idSucursal),
          loadActividadReciente(idSucursal)
        ]);
      } catch (error) {
        console.error("Error inicializando el dashboard:", error);
      }
    }

    // Carga el resumen general (ventas, ingresos, egresos, balance)
    async function loadResumenDashboard(idSucursal) {
  try {
    const res = await fetchWithAuth(`http://192.168.1.76:8000/dashboard/resumen/${idSucursal}`);
    if (!res.ok) throw new Error("Error al obtener el resumen del dashboard.");
    const resumen = await res.json();
    // Mostrar Ingresos Brutos con signo de pesos
    document.getElementById("totalVentas").textContent = `$${Number(resumen.ventas_totales).toFixed(2)}` || "$0.00";
    document.getElementById("ingresosTotales").textContent = `$${Number(resumen.ingresos_totales).toFixed(2)}`;
    document.getElementById("egresosTotales").textContent = `$${Number(resumen.egresos_totales).toFixed(2)}`;
    document.getElementById("balance").textContent = `$${Number(resumen.balance).toFixed(2)}`;
  } catch (error) {
    console.error("Error al cargar el resumen:", error);
  }
}


    // Carga los productos más vendidos y renderiza el gráfico
  

    // Carga la actividad reciente: últimas entradas y salidas
    async function loadActividadReciente(idSucursal) {
      try {
        const res = await fetchWithAuth(`http://192.168.1.76:8000/dashboard/actividad_reciente/${idSucursal}`);
        if (!res.ok) throw new Error("Error al obtener la actividad reciente.");
        const actividad = await res.json();
        const lista = document.getElementById("actividad-reciente");
        lista.innerHTML = "";
        // Se asume que la respuesta contiene dos arreglos: ultimas_entradas y ultimas_salidas
        if (actividad.ultimas_entradas) {
          actividad.ultimas_entradas.forEach(item => {
            const li = document.createElement("li");
            li.textContent = `Entrada - ID: ${item.idEntrada} | Producto: ${item.idProducto} | Cantidad: ${item.cantidad}`;
            lista.appendChild(li);
          });
        }
        if (actividad.ultimas_salidas) {
          actividad.ultimas_salidas.forEach(item => {
            const li = document.createElement("li");
            li.textContent = `Salida - ID: ${item.idSalida} | Producto: ${item.idProducto} | Cantidad: ${item.cantidad}`;
            lista.appendChild(li);
          });
        }
      } catch (error) {
        console.error("Error al cargar la actividad reciente:", error);
      }
    }

    // Renderiza el gráfico de ventas por producto usando Chart.js
    async function loadProductosMasVendidos(idSucursal) {
  try {
    const res = await fetchWithAuth(`http://192.168.1.76:8000/dashboard/productos_mas_vendidos/${idSucursal}`);
    if (!res.ok) throw new Error("Error al obtener productos más vendidos.");
    const productos = await res.json();
    if (productos && productos.length > 0) {
      // Mostrar el nombre del top producto vendido
      document.getElementById("topProducto").textContent = productos[0].nombre;
      renderGraficoProductos(productos);
    } else {
      document.getElementById("topProducto").textContent = "-";
      renderGraficoProductos([]);
    }
  } catch (error) {
    console.error("Error al cargar productos más vendidos:", error);
  }
}

function renderGraficoProductos(productos) {
  const ctx = document.getElementById("graficoProductos").getContext("2d");
  // Usar el nombre del producto en los labels
  const labels = productos.map(p => p.nombre);
  const data = productos.map(p => p.total_vendido);
  if (window.chartProducto) window.chartProducto.destroy();
  window.chartProducto = new Chart(ctx, {
    type: "pie",
    data: {
      labels: labels,
      datasets: [{
        label: "Ventas por Producto",
        data: data,
        backgroundColor: [
          "rgba(255, 99, 132, 0.5)",
          "rgba(54, 162, 235, 0.5)",
          "rgba(255, 206, 86, 0.5)",
          "rgba(75, 192, 192, 0.5)",
          "rgba(153, 102, 255, 0.5)"
        ],
        borderColor: [
          "rgba(255, 99, 132, 1)",
          "rgba(54, 162, 235, 1)",
          "rgba(255, 206, 86, 1)",
          "rgba(75, 192, 192, 1)",
          "rgba(153, 102, 255, 1)"
        ],
        borderWidth: 1
      }]
    },
    options: { responsive: true }
  });
}

  </script>
</body>
</html>
